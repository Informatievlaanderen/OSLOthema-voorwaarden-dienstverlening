@prefix cpsv: <http://purl.org/vocab/cpsv#> .
@prefix dbpedia: <http://dbpedia.org/ontology#> .
@prefix dc: <http://purl.org/dc/terms#> .
@prefix dcat: <http://www.w3.org/ns/dcat#> .
@prefix dossier: <https://data.vlaanderen.be/ns/dossier#> .
@prefix eli: <http://data.europa.eu/eli/ontology#>
@prefix eu: <https://data.europa.eu/m8g#> .
@prefix example: <https://example.org/ns#> .
@prefix foaf: <http://xmlns.com/foaf/0.1#> .
@prefix p-plan: <http://purl.org/net/p-plan#> .	
@prefix persoon: <https://data.vlaanderen.be/ns/persoon#> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix sd: <https://www.w3.org/TR/sparql12-service-description/#lang-sparql12query> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix skos: 	<http://www.w3.org/2004/02/skos/core#> .
@prefix step: <https://fast.ilabt.imec.be/ns/oslo-steps#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# This example builds upon the CCCEV, OSLO-STEPS and p-plan vocabularies.
# In order to reduce complexity, this example does not concern itself with the reasoning at each step / activity. 
# This is outside the model, but at each state the activity output is added to the knowledge graph.

# 1. Legal backing.
_:publicService a cpsv:PublicService ;
    example:instantiates _:mariage ;
    cpsv:follows _:rule .

_:rule a cpsv:Rule ;
    cpsv:implements _:legalResource .

_:legalResource a eli:LegalResource .

# 2. Definition of the procedure.
_:mariageDeclaration a p-plan:Plan ;
    dc:description "Mariage declaration" ;
    p-plan:isSubPlanOfPlan _:mariage ;

# 2.1. Age requirement

_:hasRequiredAgeToMarry a p-plan:Plan,eu:Requirement ;
    dc:description "Establish that registered person is sufficiently old to marry." ;
    p-plan:isSubPlanOfPlan _:mariageDeclaration ;
    eu:hasSupportingEvidence _:courtDecision .

_:ageAbove18 a p-plan, eu:Requirement ;
    p-plan:isSubPlanOfPlan _:hasRequiredAgeToMarry ;
    dc:description "Establish that registered person is above 18 of age." ;
    eu:hasSupportingEvidence _:eID ;
    eu:fulfils _:rule .

_:eID a eu:Evidence ;
    dcat:identifier "xxx-xxxxxxx-xx" ;
    dcat:type "Authentication certificate of eID card";
    dc:isAbout _:subject ;
    eu:supportsConcept _:obtainAge .
    dcat:distribution _:eIDDistribution ;

_:eIDDistribution a dcat:Distribution ;
    dc:conformsTo persoon:GeregistreerdPersoon .

_:obtainAge a p-plan:Step, eu:InformationConcept ;
    dc:description "Obtain the age of citizen based on the date of birth." ;
    p-plan:isStepOfPlan _:ageAbove18 ;
    step:requiresState _:stateShape1 .

# @prefix persoon: <https://data.vlaanderen.be/ns/persoon#> .
# @prefix sh: <http://www.w3.org/ns/shacl#> .
#
# persoon:GeregistreerdPersoon
#     a sh:NodeShape ;
#     sh:targetNode persoon:GeregistreerdPersoon .
_:stateShape1 a sh:NodeShape, p-plan:Variable .

_:isAgeAbove18 a p-plan:Step ;
    dc:description "Verify that the registered person's age is above 18." ;
    p-plan:isStepOfPlan _:ageAbove18 ;
    p-plan:isPreceededBy _:obtainAge ;
    step:requiresState _:stateShape2 .

# @prefix persoon: <https://data.vlaanderen.be/ns/persoon#> .
# @prefix sh: <http://www.w3.org/ns/shacl#> .
# @prefix example: <http://example.org/ns#> .

# persoon:GeregistreerdPersoon
#     a sh:NodeShape ;
#     sh:targetNode persoon:GeregistreerdPersoon ;
#     sh:property [
#         sh:path example:age ;
#         sh:datatype xsd:integer ;
#         sh:minCount 1 
#     ] .
_:stateShape2 a sh:NodeShape, p-plan:Variable .

 _:courtDecision a eu:Evidence ;
    dcat:type "Court decision";
    dc:isAbout _:subject ;
    eu:supportsConcept _:personIsDeclaredMajor .

_:personIsDeclaredMajor a p-plan:Step, eu:InformationConcept ;
    dc:description "Verify whether the family court declared the person major." ;
    p-plan:isStepOfPlan _:hasRequiredAgeToMarry ;
    step:requiresState _:stateShape3 .

# @prefix example: <https://example.org/ns#> .
# @prefix person: <http://www.w3.org/ns/person#> .
# @prefix persoon: <https://data.vlaanderen.be/ns/persoon#> .
# @prefix sh: <http://www.w3.org/ns/shacl#> .
# @prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# persoon:GeregistreerdPersoon
#     a sh:NodeShape ;
#     sh:targetNode persoon:GeregistreerdPersoon ;
#     sh:property [
#        sh:path example:isDeclaredMajor ;
#        sh:datatype xsd:boolean ;
#     ] .
_:stateShape3 a sh:NodeShape, p-plan:Variable .

_:subject a persoon:GeregistreerdPersoon ;
    persoon:registratie "90110848689" ;
    persoon:heeftGeboorte _:dob ;
    persoon:heeftBurgelijkeStaat _:maritalStatus .

_:dob a persoon:Geboorte ;
    persoon:datum "1990-11-08T00:00:00"^^xsd:dateTime .

_:maritalStatus a persoon:BurgelijkeStaat ;
    persoon:type _:maritalStatusType .

_:maritalStatusType a skos:Concept ;
    skos:preLabel "Ongehuwd" .

# 2.2. Bachelor requirement
_:isBachelor a p-plan:Plan,eu:Requirement ;
    dc:description "The marital status is single." ;
    p-plan:isSubPlanOfPlan _:mariageDeclaration ;
    eu:hasSupportingEvidence _:extractPopulationRegistry .

_:extractPopulationRegistry a eu:Evidence ;
    dcat:type "Extract of the population registry";
    dc:isAbout _:subject ;
    eu:supportsConcept _:maritalStatusIsSingle ;
    dcat:distribution _:extractPopulationRegistryDistribution .

_:extractPopulationRegistryDistribution a dcat:Distribution ;
    dc:conformsTo persoon:GeregistreerdPersoon .

_:maritalStatusIsSingle a eu:InformationConcept, p-plan:Step ;
    dc:description "Verify whether the marital status is single." ;
    p-plan:isStepOfPlan _:isBachelor ;
    step:requiresState _:stateShape4 .

# @prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
# @prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
# @prefix sh: <http://www.w3.org/ns/shacl#> .
# @prefix persoon: <http://example.org/persoon#> .
# @prefix skos: <http://www.w3.org/2004/02/skos/core#> .

# persoon:GeregistreerdPersoonShape
#     a sh:NodeShape ;
#     sh:targetClass persoon:GeregistreerdPersoon ;
#     sh:property [
#         sh:path persoon:heeftBurgelijkeStaat ;
#         sh:node persoon:BurgelijkeStaatShape ;
#     ] .

# persoon:BurgelijkeStaatShape
#     a sh:NodeShape ;
#     sh:targetClass persoon:BurgelijkeStaat ;
#     sh:property [
#         sh:path persoon:type ;
#         sh:node persoon:BurgelijkeStaatTypeShape ;
#     ] .

# persoon:BurgelijkeStaatTypeShape
#     a sh:NodeShape ;
#     sh:targetClass skos:Concept ;
#     sh:property [
#         sh:path skos:preLabel ;
#         sh:minCount 1 ;
#     ] .
_:stateShape4 a sh:NodeShape, p-plan:Variable .


# 3. Execution of the procedure.
_:case a dbpedia:Case .
    dossier:doorloopt (_:activity1 _:activity2)

_:activity1 a p-plan:Activity, dossier:Procedurestap ;
    p-plan:correspondsToStep _:obtainAge ;
    prov:used _:entity1 ;

_:entity1 a p-plan:Entity ;
    p-plan:correspondsToVariable _:stateShape1 ;
    prov:value """
    {
        "@context": [
        "https://data.vlaanderen.be/context/persoon-basis.jsonld",
        {"xsd": "http://www.w3.org/2001/XMLSchema#"}
        ],
        "@id": "_:subject",
        "@type": "GeregistreerdPersoon",
        "heeftGeboorte": {
            "@type": "Geboorte",
            "datum": {
                "@value": "1990-11-08T00:00:00",
                "@type": "xsd:dateTime"
            }
        }
    }
    """ .

_:activity2 a p-plan:Activity, dossier:Procedurestap ;
    p-plan:correspondsToStep _:isAgeAbove18 ;
    prov:wasInformedBy _:activity1 .